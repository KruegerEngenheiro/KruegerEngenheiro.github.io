<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Fretamento - 1¬∞ Ten KRUEGER</title>
    <style>
        :root { 
            --verde-oliva: #4B5320; 
            --verde-escuro: #353b16;
            --caqui: #f0e68c; 
            --bg: #f4f4ed; 
            --text: #2c2e22;
            --branco: #ffffff;
            --borda: #cbd5e0;
        }

        body { font-family: 'Segoe UI', Roboto, Arial, sans-serif; margin: 0; background: var(--bg); color: var(--text); }

        /* CABE√áALHO CENTRALIZADO COM IMAGENS NAS PONTAS */
        header { 
            background: linear-gradient(135deg, var(--verde-escuro) 0%, var(--verde-oliva) 100%);
            color: var(--branco); padding: 20px 40px; box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            border-bottom: 6px solid var(--caqui);
        }

        .header-container { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            max-width: 1400px; 
            margin: 0 auto; 
        }

        .header-logo { width: 120px; height: 80px; object-fit: contain; border: 2px solid rgba(255,255,255,0.3); border-radius: 4px; }
        
        .header-center { text-align: center; flex: 1; }
        .header-center h1 { margin: 0; font-size: 24px; text-transform: uppercase; letter-spacing: 2px; }
        .header-center p { margin: 5px 0 0; font-size: 14px; opacity: 0.9; }

        .responsavel-box { margin-top: 10px; font-size: 12px; background: rgba(0,0,0,0.2); padding: 4px 15px; border-radius: 20px; display: inline-block; border: 1px solid var(--caqui); }

        /* LAYOUT */
        .layout { display: flex; min-height: calc(100vh - 250px); }
        nav { width: 250px; background: #23290b; color: var(--branco); }
        nav ul { list-style: none; padding: 0; margin: 0; }
        nav li { padding: 20px; cursor: pointer; border-bottom: 1px solid rgba(255,255,255,0.05); font-weight: bold; font-size: 13px; transition: 0.3s; text-transform: uppercase; }
        nav li.active { background: var(--verde-oliva); color: var(--caqui); border-left: 8px solid var(--caqui); }

        /* CONTE√öDO */
        main { flex: 1; padding: 30px; box-sizing: border-box; }
        .card { background: var(--branco); padding: 30px; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); border-top: 5px solid var(--verde-oliva); }

        /* PAINEL ESTRAT√âGICO CENTRALIZADO */
        .dashboard-central { text-align: center; padding: 20px 0; }
        #total-km { color: var(--verde-oliva); font-size: 5rem; font-weight: 900; line-height: 1; margin: 20px 0; }
        .texto-institucional { max-width: 700px; margin: 30px auto 0; font-style: italic; color: #555; line-height: 1.6; border-top: 1px solid #eee; padding-top: 20px; }

        /* GRID DE SELE√á√ÉO CORRIGIDO */
        .grid-baixa { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
            gap: 20px; 
            margin-bottom: 20px;
        }

        .form-group { display: flex; flex-direction: column; width: 100%; }
        label { margin-bottom: 8px; font-weight: 700; font-size: 12px; color: var(--verde-escuro); text-transform: uppercase; }

        select, input { 
            width: 100%; 
            padding: 12px 15px; 
            border: 2px solid var(--borda); 
            border-radius: 8px;
            font-size: 14px; 
            box-sizing: border-box; /* GARANTE QUE N√ÉO SAIA DO BLOCO */
            outline: none;
            background-color: #fcfcfc;
        }
        select:focus, input:focus { border-color: var(--verde-oliva); background-color: #fff; }

        button { 
            background: var(--verde-oliva); color: var(--branco); border: none; padding: 18px; 
            border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; 
            font-size: 15px; text-transform: uppercase; margin-top: 10px; transition: 0.3s;
        }
        button:hover { background: var(--verde-escuro); transform: translateY(-2px); }

        /* TABELA */
        .table-container { overflow-x: auto; margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #f8f9fa; color: var(--verde-oliva); padding: 15px; text-align: left; font-size: 11px; text-transform: uppercase; border-bottom: 2px solid #ddd; }
        td { padding: 15px; border-bottom: 1px solid #eee; font-size: 13px; }

        footer { background: #1a1c12; color: #888; text-align: center; padding: 20px; font-size: 12px; border-top: 5px solid var(--verde-oliva); }
    </style>
</head>
<body>

<header>
    <div class="header-container">
        <img src="https://www.gov.br/defesa/pt-br/assuntos/operacao-acolhida/fotos/acolhida-topo.jpg" class="header-logo" alt="Logo Op Acolhida">
        
        <div class="header-center">
            <h1>Sistema de Fretamento Rodovi√°rio</h1>
            <p>For√ßa-Tarefa Log√≠stica Humanit√°ria - Opera√ß√£o Acolhida</p>
            <div class="responsavel-box">Gestor T√©cnico: <strong>1¬∞ Ten KRUEGER</strong></div>
        </div>

        <img src="https://www.exercito.mil.br/documents/10138/11181813/acolhida-4.jpg" class="header-logo" alt="Transporte Militar">
    </div>
</header>

<div class="layout">
    <nav>
        <ul>
            <li onclick="showView('dashboard')" class="active" id="nav-dashboard">üìä Painel Estrat√©gico</li>
            <li onclick="showView('viagem')" id="nav-viagem">üöõ Registrar Utiliza√ß√£o</li>
            <li onclick="showView('contratos')" id="nav-contratos">üìã Saldos Dispon√≠veis</li>
        </ul>
    </nav>

    <main>
        <section id="view-dashboard">
            <div class="card dashboard-central">
                <label style="font-size: 14px; letter-spacing: 1px;">Saldo Consolidado Total</label>
                <div id="total-km">0</div>
                <div style="font-weight: bold; color: var(--verde-oliva); margin-top: -10px;">QUIL√îMETROS DISPON√çVEIS</div>
                
                <div class="texto-institucional">
                    "O fretamento rodovi√°rio √© um dos pilares da log√≠stica de interioriza√ß√£o da Opera√ß√£o Acolhida. 
                    Atrav√©s deste sistema, garantimos a mobilidade eficiente e digna de cidad√£os em vulnerabilidade, 
                    conectando centros de acolhimento aos destinos de destino em todo o territ√≥rio nacional, 
                    assegurando o cumprimento da miss√£o humanit√°ria com precis√£o e controle de recursos."
                </div>
            </div>
        </section>

        <section id="view-viagem" style="display:none;">
            <div class="card">
                <h2 style="margin-top:0; color: var(--verde-oliva);">Registrar Utiliza√ß√£o de Cr√©dito</h2>
                
                <div class="grid-baixa">
                    <div class="form-group">
                        <label>Estado de Atua√ß√£o</label>
                        <select id="filtro-estado" onchange="filtrarOpcoes()">
                            <option value="">Sincronizando estados...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Tipo de Ve√≠culo</label>
                        <select id="filtro-veiculo" onchange="filtrarOpcoes()">
                            <option value="">Selecione o tipo...</option>
                            <option value="√înibus">√înibus</option>
                            <option value="Micro-√¥nibus">Micro-√¥nibus</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Quantidade de KM</label>
                        <input type="number" id="input-km" placeholder="Ex: 450">
                    </div>
                </div>

                <div class="form-group">
                    <label>Empresa Fornecedora / Item do Contrato</label>
                    <select id="select-contrato-final">
                        <option value="">Selecione os filtros acima para listar...</option>
                    </select>
                </div>

                <button onclick="confirmarBaixa()" id="btn-submit">Efetivar Baixa no Sistema</button>
            </div>
        </section>

        <section id="view-contratos" style="display:none;">
            <div class="card">
                <h2 style="margin-top:0; color: var(--verde-oliva);">Relat√≥rio Detalhado de Contratos</h2>
                <div class="table-container">
                    <table id="tabela-saldos">
                        <thead>
                            <tr>
                                <th>Empresa</th>
                                <th>Contrato</th>
                                <th>Item</th>
                                <th>Ve√≠culo</th>
                                <th>Saldo (KM)</th>
                                <th>Abrang√™ncia</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </section>
    </main>
</div>

<footer>
    <strong>Opera√ß√£o Acolhida</strong> | Gest√£o de Fretamento | Respons√°vel: <strong>1¬∞ Ten KRUEGER</strong> &copy; 2025
</footer>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbzSpuel12QFFJ74XbNxNlCaRg25bW4eFDvSaD6vfaQZl40Fr7TTiYRes5IbFB2B2Ug/exec"; 
    let dadosPlanilha = [];

    function showView(view) {
        ['dashboard', 'viagem', 'contratos'].forEach(v => {
            document.getElementById('view-' + v).style.display = (v === view) ? 'block' : 'none';
            document.getElementById('nav-' + v).classList.toggle('active', v === view);
        });
    }

    async function carregarDados() {
        try {
            const res = await fetch(API_URL + "?t=" + new Date().getTime());
            dadosPlanilha = await res.json();
            povoarEstados();
            atualizarInterface();
        } catch (e) { console.error(e); }
    }

    function povoarEstados() {
        const sel = document.getElementById("filtro-estado");
        let ests = new Set();
        dadosPlanilha.forEach(i => { if(i.ESTADOS) i.ESTADOS.split(',').forEach(e => ests.add(e.trim())); });
        sel.innerHTML = '<option value="">Todos os Estados</option>';
        Array.from(ests).sort().forEach(e => { sel.innerHTML += `<option value="${e}">${e}</option>`; });
    }

    function atualizarInterface() {
        const tbody = document.querySelector("#tabela-saldos tbody");
        const displayTotal = document.getElementById("total-km");
        tbody.innerHTML = "";
        let soma = 0;

        dadosPlanilha.forEach(item => {
            let n = parseFloat(String(item.SALDO_DISPONIVEL || "0").replace(/\./g, '').replace(',', '.')) || 0;
            soma += n;
            tbody.innerHTML += `<tr>
                <td>${item.EMPRESA}</td>
                <td>${item.CONTRATO}</td>
                <td>${item.ITEM}</td>
                <td>${item.VEICULO}</td>
                <td style="font-weight:700">${n.toLocaleString('pt-BR')}</td>
                <td>${item.ESTADOS}</td>
            </tr>`;
        });
        displayTotal.innerText = soma.toLocaleString('pt-BR');
    }

    function filtrarOpcoes() {
        const est = document.getElementById("filtro-estado").value;
        const vei = document.getElementById("filtro-veiculo").value;
        const sel = document.getElementById("select-contrato-final");
        sel.innerHTML = '<option value="">Selecione um contrato...</option>';

        dadosPlanilha.filter(i => {
            return (est === "" || i.ESTADOS.includes(est)) && (vei === "" || i.VEICULO.trim() === vei);
        }).forEach(i => {
            sel.innerHTML += `<option value="${i.ID_CONTROLE}" data-saldo="${i.SALDO_DISPONIVEL}">
                ${i.EMPRESA} | Item: ${i.ITEM} | Saldo: ${i.SALDO_DISPONIVEL} KM
            </option>`;
        });
    }

    async function confirmarBaixa() {
        const id = document.getElementById("select-contrato-final").value;
        const km = document.getElementById("input-km").value;
        const btn = document.getElementById("btn-submit");
        if(!id || !km) { alert("Preencha todos os campos."); return; }
        if(!confirm("Confirmar abate de KM no sistema?")) return;
        btn.disabled = true; btn.innerText = "Sincronizando...";
        try {
            const r = await fetch(API_URL, { method: "POST", body: JSON.stringify({ id, km }) });
            if(await r.text() === "Sucesso") { alert("Baixa realizada!"); location.reload(); }
            else { alert("Erro."); btn.disabled = false; }
        } catch(e) { alert("Erro de rede."); btn.disabled = false; }
    }

    window.onload = carregarDados;
</script>
</body>
</html>